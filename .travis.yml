sudo: false
dist: trusty
language: rust
rust:
  - nightly
  - stable
matrix:
  allow_failures:
    - rust: stable


# Dependencies of kcov, used by coverage
addons:
  apt:
    packages:
      - libcurl4-openssl-dev
      - libelf-dev
      - libdw-dev
      - cmake
      - gcc
      - binutils-dev
      - zlib1g-dev
      - libbfd-dev

cache: 
  cargo: true
  directories:
    - tools

before_script:
  # Install tools if not already installed
  - cargo install --list | grep clippy || cargo install clippy
  - cargo install --list | grep rustfmt || cargo install rustfmt
  - cargo install --list | grep cargo-update || cargo install cargo-update
  # Update all tools
  - cargo install-update -a || true # sometimes nightly breaks stuff, that's okay
  
  # Install code coverage tool if not already installed
  - find tools/usr/local/bin/kcov || 
    wget https://github.com/SimonKagstrom/kcov/archive/master.tar.gz &&
    tar xzf master.tar.gz &&
    cd kcov-master &&
    mkdir build &&
    cd build &&
    cmake .. &&
    make &&
    make install DESTDIR=../../tools &&  
    cd ../.. &&
    rm -rf kcov-master
  
  # Lint
  - cd core
  - cargo fmt -- --write-mode=diff
  - cargo clippy -- -Z no-trans -D clippy 


after_success:
  - cd ..
  - ./tools/usr/local/bin/kcov --coveralls-id=$TRAVIS_JOB_ID --exclude-pattern=/.cargo,/usr/lib --verify target/cov target/debug/shootr-*
